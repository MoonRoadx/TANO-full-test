<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Sistema di tracciamento interventi meccanici - Tano Evoluzione"/>
  <title>Tano Evoluzione - Sistema NFC</title>

  <script src="https://cdn.tailwindcss.com "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js "></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: url('Background.png') no-repeat center center fixed;
      background-size: cover;
      color: white;
      min-height: 100vh;
      opacity: 0;
      animation: fadeIn 1s ease-in-out forwards;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.65) 50%, rgba(0,0,0,0.85) 100%);
      backdrop-filter: blur(2px);
      z-index: -1;
    }
    #app { background: rgba(0,0,0,0.45); min-height: 100vh; padding-bottom: 50px; }
    .bg-white {
      background-color: rgba(30,30,35,0.88) !important;
      backdrop-filter: blur(12px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      transition: all 0.4s ease;
    }
    .bg-white p, .bg-white span, .bg-white h2, .bg-white h3 { color: #e5e7eb !important; }
    .text-gray-600, .text-gray-500, .text-gray-700 { color: #d1d5db !important; }
    .text-blue-600 { color: #60a5fa !important; }
    input, textarea, select {
      color: #f3f4f6 !important;
      background-color: rgba(45,45,50,0.95) !important;
      border: 2px solid rgba(75,85,99,0.8) !important;
    }
    input::placeholder, textarea::placeholder { color: #9ca3af !important; }
    input:focus, textarea:focus, select:focus {
      outline: none; box-shadow: 0 0 0 4px rgba(59,130,246,0.3); border-color: #3b82f6 !important;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .notification {
      position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
    .modal-content { background: rgba(30,30,35,0.95); border-radius: 12px; padding: 24px; max-width: 500px; width: 100%; border: 1px solid rgba(255,255,255,0.15); }
    #qrcode { display: flex; justify-content: center; padding: 20px; background: white; border-radius: 8px; margin: 16px 0; }
    .loading {
      display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pdf-button {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      transition: all 0.3s ease;
    }
    .pdf-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }
    .offline-indicator {
      position: fixed; bottom: 20px; left: 20px; padding: 12px 20px; background: rgba(245, 158, 11, 0.9);
      color: white; border-radius: 8px; font-weight: bold; z-index: 1001; animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .tag {
      display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; margin-bottom: 5px;
    }
    .tag-urgent { background: #dc2626; color: white; }
    .tag-warranty { background: #059669; color: white; }
    .tag-recurring { background: #2563eb; color: white; }
    .tag-parts { background: #7c3aed; color: white; }
    .stock-low { background: #f59e0b; color: white; }
    .stock-empty { background: #dc2626; color: white; }
    .tab-button {
      padding: 8px 16px;
      border-radius: 8px 8px 0 0;
      background: rgba(55,65,81,0.5);
      color: #d1d5db;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .tab-button.active {
      background: rgba(30,30,35,0.88);
      color: white;
      border-bottom: 2px solid #3b82f6;
    }
    .tab-content {
      display: none;
      background: rgba(30,30,35,0.88);
      border-radius: 0 8px 8px 8px;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
        <div class="loading mx-auto mb-4"></div>
        <p class="text-gray-300">Caricamento Firebase...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js ";
    import { getFirestore, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js ";

    const firebaseConfig = {
      apiKey: "AIzaSyBiU0Q_xfHBLlGHh0vbeZpBAc1uoRz554",
      authDomain: "tano-client-serveur.firebaseapp.com",
      projectId: "tano-client-serveur",
      storageBucket: "tano-client-serveur.firebasestorage.app",
      messagingSenderId: "83806701673",
      appId: "1:83806701673:web:6e44a0ebd99ea0a75cfaf8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    try {
      await enableIndexedDbPersistence(db);
      console.log("‚úÖ Mode hors ligne activ√©");
    } catch (err) {
      console.log("‚ö†Ô∏è Erreur persistance:", err.code);
    }
    
    window.firebaseDB = db;
    window.firebaseReady = true;
    console.log("‚úÖ Firebase initialized");
    window.dispatchEvent(new Event('firebaseReady'));
  </script>

  <script>
    const MECHANIC_PIN = "1234";
    const USE_FIREBASE = true;

    const vehicleDatabase = {
      "Fiat": ["Panda", "500", "Punto", "Tipo", "Dobl√≤", "500L", "500X", "124 Spider", "Multipla", "Bravo", "Stilo", "Croma", "Freemont", "Barchetta", "Coupe", "Ulysse", "Sedici", "Idea", "Linea", "Ducato"],
      "Alfa Romeo": ["Giulia", "Stelvio", "Giulietta", "Mito", "159", "147", "156", "166", "Brera", "Spider", "GT", "GTV", "164", "155", "33", "Alfasud", "Alfetta", "Giulietta Spider"],
      "Lancia": ["Ypsilon", "Delta", "Musa", "Phedra", "Thesis", "Lybra", "Kappa", "Zeta", "Prisma", "Dedra", "Thema"],
      "BMW": ["Serie 1", "Serie 2", "Serie 3", "Serie 4", "Serie 5", "Serie 6", "Serie 7", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "Z4", "M3", "M4", "M5", "i3", "i4", "iX"],
      "Mercedes": ["Classe A", "Classe B", "Classe C", "Classe E", "Classe S", "Classe G", "GLA", "GLB", "GLC", "GLE", "GLS", "SL", "SLK", "AMG GT", "EQA", "EQC", "EQS", "Vito", "Sprinter"],
      "Audi": ["A1", "A2", "A3", "A4", "A5", "A6", "A7", "A8", "Q2", "Q3", "Q4", "Q5", "Q7", "Q8", "TT", "R8", "e-tron"],
      "Volkswagen": ["Golf", "Passat", "Polo", "Tiguan", "Touareg", "T-Roc", "T-Cross", "Arteon", "Up!", "Beetle", "Jetta", "Scirocco", "Sharan", "Touran", "Transporter", "Caddy"],
      "Renault": ["Clio", "Captur", "M√©gane", "Sc√©nic", "Kadjar", "Koleos", "Twingo", "Espace", "Laguna", "Zo√©", "Talisman", "Kangoo", "Trafic"],
      "Peugeot": ["208", "308", "508", "2008", "3008", "5008", "108", "408", "607", "807", "Expert", "Partner", "Boxer"],
      "Citro√´n": ["C3", "C4", "C5", "C1", "C2", "C6", "C8", "Berlingo", "Jumpy", "Jumper", "DS3", "DS4", "DS5"],
      "Opel": ["Corsa", "Astra", "Insignia", "Mokka", "Crossland", "Grandland", "Zafira", "Vivaro", "Movano", "GT", "Speedster"],
      "Ford": ["Fiesta", "Focus", "Mondeo", "Kuga", "Puma", "EcoSport", "Edge", "Galaxy", "S-Max", "Mustang", "Ranger", "Transit"],
      "Toyota": ["Yaris", "Corolla", "Camry", "RAV4", "C-HR", "Highlander", "Hilux", "Land Cruiser", "Supra", "Aygo", "Prius", "Mirai"],
      "Dacia": ["Sandero", "Duster", "Lodgy", "Dokker", "Logan", "Spring", "Jogger"],
      "Jeep": ["Renegade", "Compass", "Cherokee", "Grand Cherokee", "Wrangler", "Commander"],
      "Volvo": ["XC40", "XC60", "XC90", "S60", "S90", "V40", "V60", "V90", "C40", "EX90"]
    };

    const garageInfo = {
      name: "Tano Evoluzione - Bosch Car Service",
      address: "Via Roma 123, 00100 Roma RM",
      phone: "06 123 4567",
      email: "info@tanoevoluzione.it",
      vatNumber: "IT12345678901",
      website: "www.tanoevoluzione.it"
    };

    const translations = {
      it: {
        // ... existing translations ...
        typeOther: "Altro", clientInfo: "Informazioni cliente", clientName: "Nome cliente",
        clientPhone: "Telefono", clientEmail: "Email", selectBrandFirst: "Seleziona prima una marca",
        optional: "(opzionale)", photoUploadHint: "Puoi scattare foto o selezionarle dalla galleria",
        serviceOilChange: "Tagliando", serviceRepair: "Riparazione", serviceInspection: "Revisione",
        serviceTires: "Cambio gomme", serviceOther: "Altro",
        // NEW FEATURES TRANSLATIONS
        stockManagement: "Gestione Magazzino", partsStock: "Ricambi in magazzino",
        addPart: "Aggiungi Ricambio", partName: "Nome Ricambio", partCode: "Codice", partQuantity: "Quantit√†",
        partPrice: "Prezzo Unitario", partSupplier: "Fornitore", lowStock: "Scorte basse",
        outOfStock: "Esaurito", stockAlert: "Allerta Magazzino", internalNotes: "Note Interne",
        addInternalNote: "Aggiungi Nota", internalNotePlaceholder: "Note visibili solo ai meccanici...",
        estimates: "Preventivi", estimatesList: "Lista Preventivi", createEstimate: "Crea Preventivo",
        estimateNumber: "Numero Preventivo", convertToInvoice: "Converti in Fattura", 
        reminderSent: "Promemoria inviato", sendReminder: "Invia Promemoria",
        warrantyExpire: "Garanzia in scadenza", warrantyExpired: "Garanzia scaduta",
        nextService: "Prossimo tagliando", serviceReminder: "Promemoria manutenzione"
      },
      fr: {
        // ... existing translations ...
        typeOther: "Autre", clientInfo: "Infos client", clientName: "Nom client",
        clientPhone: "T√©l√©phone", clientEmail: "Email", selectBrandFirst: "S√©lectionnez d'abord une marque",
        optional: "(optionnel)", photoUploadHint: "Vous pouvez prendre des photos ou les s√©lectionner depuis la galerie",
        serviceOilChange: "Vidange", serviceRepair: "R√©paration", serviceInspection: "R√©vision",
        serviceTires: "Changement pneus", serviceOther: "Autre",
        // NEW FEATURES TRANSLATIONS
        stockManagement: "Gestion Stock", partsStock: "Pi√®ces en stock",
        addPart: "Ajouter Pi√®ce", partName: "Nom Pi√®ce", partCode: "Code", partQuantity: "Quantit√©",
        partPrice: "Prix Unitaire", partSupplier: "Fournisseur", lowStock: "Stock bas",
        outOfStock: "Rupture", stockAlert: "Alerte Stock", internalNotes: "Notes Internes",
        addInternalNote: "Ajouter Note", internalNotePlaceholder: "Notes visibles uniquement par les m√©caniciens...",
        estimates: "Devis", estimatesList: "Liste Devis", createEstimate: "Cr√©er Devis",
        estimateNumber: "Num√©ro Devis", convertToInvoice: "Convertir en Facture",
        reminderSent: "Rappel envoy√©", sendReminder: "Envoyer Rappel",
        warrantyExpire: "Garantie expirante", warrantyExpired: "Garantie expir√©e",
        nextService: "Prochain entretien", serviceReminder: "Rappel entretien"
      },
      en: {
        // ... existing translations ...
        typeOther: "Other", clientInfo: "Client info", clientName: "Client name",
        clientPhone: "Phone", clientEmail: "Email", selectBrandFirst: "Select brand first",
        optional: "(optional)", photoUploadHint: "You can take photos or select from gallery",
        serviceOilChange: "Oil Change", serviceRepair: "Repair", serviceInspection: "Inspection",
        serviceTires: "Tire Change", serviceOther: "Other",
        // NEW FEATURES TRANSLATIONS
        stockManagement: "Stock Management", partsStock: "Parts in stock",
        addPart: "Add Part", partName: "Part Name", partCode: "Code", partQuantity: "Quantity",
        partPrice: "Unit Price", partSupplier: "Supplier", lowStock: "Low stock",
        outOfStock: "Out of stock", stockAlert: "Stock Alert", internalNotes: "Internal Notes",
        addInternalNote: "Add Note", internalNotePlaceholder: "Notes visible only to mechanics...",
        estimates: "Estimates", estimatesList: "Estimates List", createEstimate: "Create Estimate",
        estimateNumber: "Estimate Number", convertToInvoice: "Convert to Invoice",
        reminderSent: "Reminder sent", sendReminder: "Send Reminder",
        warrantyExpire: "Warranty expiring", warrantyExpired: "Warranty expired",
        nextService: "Next service", serviceReminder: "Maintenance reminder"
      }
    };

    let currentLang = localStorage.getItem('app_language') || 'it';
    function t(key) { return translations[currentLang][key] || translations.it[key] || key; }
    function setLanguage(lang) { currentLang = lang; localStorage.setItem('app_language', lang); render(); }
    function getLanguageSelector() {
      return `<select onchange="setLanguage(this.value)" class="px-3 py-2 rounded-lg text-sm font-semibold bg-gray-700 text-white border-2 border-gray-600 hover:bg-gray-600 cursor-pointer" style="background-color: rgba(55,65,81,0.95) !important; color: white !important;">
        <option value="it" ${currentLang === 'it' ? 'selected' : ''}>üáÆüáπ Italiano</option>
        <option value="fr" ${currentLang === 'fr' ? 'selected' : ''}>üá´üá∑ Fran√ßais</option>
        <option value="en" ${currentLang === 'en' ? 'selected' : ''}>üá¨üáß English</option>
      </select>`;
    }

    // NEW STATE VARIABLES
    let vehicles = {}, currentVehicle = null, showAddForm = false, isMechanicMode = false, isClientMode = false;
    let showLoginScreen = true, searchQuery = '', showShareModal = false, shareModalTarga = null, realtimeUnsubscribe = null, showAppointmentForm = false;
    let showDashboard = false, showAdvancedSearch = false, filters = { date: '', type: '', mechanic: '', costMin: '', costMax: '' };
    let isOffline = !navigator.onLine;
    let stock = [], showStockForm = false, showStockModal = false;
    let showEstimates = false, showEstimateForm = false, currentEstimate = null;
    let internalNotes = [], showInternalNotes = false;

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => { notification.style.animation = 'slideIn 0.3s ease-out reverse'; setTimeout(() => notification.remove(), 300); }, 3000);
    }

    function showOfflineIndicator() {
      if (isOffline && isMechanicMode) {
        const indicator = document.createElement('div');
        indicator.className = 'offline-indicator';
        indicator.innerHTML = `‚ö†Ô∏è ${t('offlineMode')} - ${t('offlineMessage')}`;
        indicator.id = 'offlineIndicator';
        document.body.appendChild(indicator);
      } else {
        const indicator = document.getElementById('offlineIndicator');
        if (indicator) indicator.remove();
      }
    }

    // STOCK MANAGEMENT FUNCTIONS
    function loadStock() {
      try {
        const stored = localStorage.getItem('garage_stock');
        if (stored) stock = JSON.parse(stored);
      } catch (error) { stock = []; }
    }

    function saveStock() {
      try { localStorage.setItem('garage_stock', JSON.stringify(stock)); } catch (error) {}
    }

    function addPart() {
      if (!isMechanicMode) return;
      const name = document.getElementById('partName').value.trim();
      const code = document.getElementById('partCode').value.trim();
      const quantity = parseInt(document.getElementById('partQuantity').value) || 0;
      const price = parseFloat(document.getElementById('partPrice').value) || 0;
      const supplier = document.getElementById('partSupplier').value.trim();
      
      if (!name || !code) {
        showNotification('‚ùå Nome e codice ricambio obbligatori', 'error');
        return;
      }
      
      const part = {
        id: Date.now(),
        name,
        code,
        quantity,
        price,
        supplier,
        createdAt: new Date().toISOString()
      };
      
      stock.push(part);
      saveStock();
      showStockForm = false;
      render();
      showNotification('‚úÖ Ricambio aggiunto');
    }

    function updateStock(id, delta) {
      if (!isMechanicMode) return;
      const part = stock.find(p => p.id === id);
      if (part) {
        part.quantity = Math.max(0, part.quantity + delta);
        saveStock();
        render();
      }
    }

    function deletePart(id) {
      if (!isMechanicMode) return;
      if (confirm('Eliminare questo ricambio?')) {
        stock = stock.filter(p => p.id !== id);
        saveStock();
        render();
      }
    }

    function checkStockAlerts() {
      return stock.filter(p => p.quantity === 0 || p.quantity <= 2);
    }

    // INTERNAL NOTES FUNCTIONS
    function addInternalNote() {
      if (!isMechanicMode || !currentVehicle) return;
      const note = document.getElementById('internalNoteText').value.trim();
      if (!note) return;
      
      if (!vehicles[currentVehicle].internalNotes) {
        vehicles[currentVehicle].internalNotes = [];
      }
      
      vehicles[currentVehicle].internalNotes.unshift({
        id: Date.now(),
        text: note,
        createdAt: new Date().toISOString(),
        author: 'Meccanico'
      });
      
      saveDataLocal();
      syncToFirestore(currentVehicle, vehicles[currentVehicle]);
      document.getElementById('internalNoteText').value = '';
      render();
    }

    // ESTIMATES FUNCTIONS
    function createEstimate() {
      if (!isMechanicMode || !currentVehicle) return;
      
      const estimate = {
        id: Date.now(),
        number: `EST-${Date.now().toString().slice(-6)}`,
        date: new Date().toISOString().split('T')[0],
        items: [],
        total: 0,
        status: 'pending' // pending, approved, rejected, converted
      };
      
      if (!vehicles[currentVehicle].estimates) vehicles[currentVehicle].estimates = [];
      vehicles[currentVehicle].estimates.push(estimate);
      currentEstimate = estimate;
      
      saveDataLocal();
      syncToFirestore(currentVehicle, vehicles[currentVehicle]);
      render();
    }

    function addEstimateItem() {
      if (!currentEstimate) return;
      
      const description = document.getElementById('estimateItemDesc').value.trim();
      const quantity = parseInt(document.getElementById('estimateItemQty').value) || 1;
      const price = parseFloat(document.getElementById('estimateItemPrice').value) || 0;
      
      if (!description) return;
      
      const item = {
        id: Date.now(),
        description,
        quantity,
        price,
        total: quantity * price
      };
      
      currentEstimate.items.push(item);
      currentEstimate.total = currentEstimate.items.reduce((sum, i) => sum + i.total, 0);
      
      saveDataLocal();
      syncToFirestore(currentVehicle, vehicles[currentVehicle]);
      render();
    }

    function convertEstimateToInvoice(estimateId) {
      const estimate = vehicles[currentVehicle].estimates.find(e => e.id === estimateId);
      if (!estimate || estimate.status === 'converted') return;
      
      // Create invoice from estimate
      const invoice = {
        id: Date.now(),
        type: 'invoice',
        date: new Date().toISOString().split('T')[0],
        descrizione: `Fattura da preventivo ${estimate.number}`,
        costo: estimate.total,
        note: `Generato da preventivo ${estimate.number}`,
        timestamp: new Date().toISOString()
      };
      
      vehicles[currentVehicle].interventi.unshift(invoice);
      estimate.status = 'converted';
      
      saveDataLocal();
      syncToFirestore(currentVehicle, vehicles[currentVehicle]);
      showNotification('‚úÖ Convertito in fattura');
      render();
    }

    // REMINDERS FUNCTIONS
    function sendServiceReminder() {
      if (!currentVehicle || !vehicles[currentVehicle].cliente?.telefono) {
        showNotification('‚ùå Telefono cliente mancante', 'error');
        return;
      }
      
      const v = vehicles[currentVehicle];
      const msg = `${t('serviceReminder')} - ${v.targa} (${v.marca} ${v.modello})`;
      
      // In a real app, this would integrate with SMS API
      const whatsappLink = `https://wa.me/${v.cliente.telefono.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
      window.open(whatsappLink, '_blank');
      showNotification('‚úÖ Promemoria inviato');
    }

    // Existing functions (generateClientCode, verifyClientCode, getClientLink, syncToFirestore, loadFromFirestore, deleteFromFirestore, loadAllVehiclesFromFirestore, loadDataLocal, saveDataLocal, validatePlate, validateEmail, validatePhone, getReminders, login, logout, updateModels, handleModelChange, addVehicle, addIntervento, deleteIntervento, deleteVehicle, addAppointment, deleteAppointment, openShareModal, copyLink, shareViaWhatsApp, shareViaEmail, updateSearch, getFilteredVehicles, getFilteredInterventions, exportToExcel, getVehicleStats, getStatistics, generateInvoice) remain the same...

    function render() {
      const app = document.getElementById('app');
      const modals = document.querySelectorAll('.modal');
      modals.forEach(m => m.remove());

      // ... existing render logic ...

      if (showLoginScreen) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full relative">
              <div class="absolute top-4 right-4">${getLanguageSelector()}</div>
              <img src="logo.png" alt="TANO Logo" class="h-24 w-24 mx-auto mb-6 object-contain" onerror="this.style.display='none'">
              <h1 class="text-3xl font-bold mb-2 text-center">${t('appName')}</h1>
              <p class="text-gray-400 mb-8 text-center">${t('appSubtitle')} ‚òÅÔ∏è</p>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color:#e5e7eb !important">${t('loginTitle')}</label>
                  <input type="text" id="loginCode" placeholder="${t('loginPlaceholder')}" class="w-full px-4 py-3 border-2 rounded-lg text-center text-xl font-bold uppercase" onkeypress="if(event.key==='Enter') login()" autofocus>
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700">üîì ${t('loginButton')}</button>
                <div class="mt-6 pt-6 border-t border-gray-700">
                  <p class="text-xs text-gray-500 text-center">üîß <strong>${t('loginMechanic')}</strong><br>üë§ <strong>${t('loginClient')}</strong><br>‚òÅÔ∏è <strong>${t('loginRealtimeSync')}</strong></p>
                </div>
              </div>
            </div>
          </div>`;
        return;
      }

      // ... existing render logic for dashboard, appointments, etc. ...

      // NEW: Stock management section in mechanic mode
      if (isMechanicMode && !currentVehicle && !showDashboard) {
        const stockAlerts = checkStockAlerts();
        const stockHtml = `
          <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-lg font-bold text-white">üì¶ ${t('stockManagement')}</h2>
              <button onclick="showStockForm=!showStockForm; render();" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">+ ${t('addPart')}</button>
            </div>
            
            ${showStockForm ? `
              <div class="bg-gray-800 p-3 rounded mb-3">
                <div class="grid grid-cols-2 gap-2 mb-3">
                  <input type="text" id="partName" placeholder="${t('partName')} *" class="px-3 py-2 border rounded">
                  <input type="text" id="partCode" placeholder="${t('partCode')} *" class="px-3 py-2 border rounded">
                  <input type="number" id="partQuantity" placeholder="${t('partQuantity')}" class="px-3 py-2 border rounded">
                  <input type="number" id="partPrice" placeholder="${t('partPrice')}" step="0.01" class="px-3 py-2 border rounded">
                  <input type="text" id="partSupplier" placeholder="${t('partSupplier')}" class="px-3 py-2 border rounded col-span-2">
                </div>
                <div class="flex gap-2">
                  <button onclick="addPart()" class="bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700">‚úÖ ${t('save')}</button>
                  <button onclick="showStockForm=false; render();" class="bg-gray-600 text-white px-4 py-2 rounded font-semibold hover:bg-gray-700">‚ùå ${t('cancel')}</button>
                </div>
              </div>
            ` : ''}

            ${stockAlerts.length > 0 ? `
              <div class="bg-yellow-900 bg-opacity-30 border-l-4 border-yellow-500 p-3 mb-3 rounded">
                <p class="text-sm text-gray-300">‚ö†Ô∏è <strong>${t('stockAlert')}:</strong> ${stockAlerts.length} ${t('partsLabel').toLowerCase()} ${t('lowStock')}</p>
              </div>
            ` : ''}

            <div class="space-y-2 max-h-96 overflow-y-auto">
              ${stock.map(part => `
                <div class="bg-gray-800 p-3 rounded flex justify-between items-center">
                  <div class="flex-1">
                    <p class="font-bold text-white">${part.name}</p>
                    <p class="text-sm text-gray-400">üì¶ ${t('partCode')}: ${part.code} | ${t('partSupplier')}: ${part.supplier || '-'}</p>
                    <p class="text-sm ${part.quantity === 0 ? 'text-red-400' : part.quantity <= 2 ? 'text-yellow-400' : 'text-green-400'}">
                      ${t('partQuantity')}: ${part.quantity} | ${t('partPrice')}: ‚Ç¨${part.price.toFixed(2)}
                    </p>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="updateStock(${part.id}, 1)" class="bg-green-600 text-white px-2 py-1 rounded text-sm">+</button>
                    <button onclick="updateStock(${part.id}, -1)" class="bg-yellow-600 text-white px-2 py-1 rounded text-sm">-</button>
                    <button onclick="deletePart(${part.id})" class="bg-red-600 text-white px-2 py-1 rounded text-sm">‚úï</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        // Insert stock section after the new vehicle form
        const appDiv = document.getElementById('app');
        const temp = document.createElement('div');
        temp.innerHTML = stockHtml;
        appDiv.insertBefore(temp.firstElementChild, appDiv.children[1]);
      }

      // ... rest of existing render logic ...

      // NEW: Internal notes section in vehicle view
      if (currentVehicle && isMechanicMode) {
        const vehicle = vehicles[currentVehicle];
        const notesSection = `
          <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="text-lg font-bold mb-3 text-white">üìù ${t('internalNotes')}</h2>
            <div class="space-y-2 mb-3">
              <textarea id="internalNoteText" rows="2" placeholder="${t('internalNotePlaceholder')}" class="w-full px-3 py-2 border rounded"></textarea>
              <button onclick="addInternalNote()" class="bg-purple-600 text-white px-4 py-2 rounded font-semibold hover:bg-purple-700">+ ${t('addInternalNote')}</button>
            </div>
            ${vehicle.internalNotes?.length ? `
              <div class="space-y-2 max-h-48 overflow-y-auto">
                ${vehicle.internalNotes.map(note => `
                  <div class="bg-gray-800 p-2 rounded border-l-4 border-purple-500">
                    <p class="text-sm text-gray-300">${note.text}</p>
                    <p class="text-xs text-gray-500 mt-1">${new Date(note.createdAt).toLocaleString()}</p>
                  </div>
                `).join('')}
              </div>
            ` : `<p class="text-gray-400 text-sm">${t('noResults')}</p>`}
          </div>
        `;
        
        // Add notes section before history
        const historyIndex = app.innerHTML.indexOf('<h2 class="text-xl font-bold mb-3 text-white">üìã');
        if (historyIndex > -1) {
          app.innerHTML = app.innerHTML.substring(0, historyIndex) + notesSection + app.innerHTML.substring(historyIndex);
        }
      }

      // NEW: Estimates section
      if (currentVehicle && isMechanicMode && showEstimates) {
        const vehicle = vehicles[currentVehicle];
        const estimatesHtml = `
          <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-lg font-bold text-white">üìã ${t('estimates')}</h2>
              <button onclick="createEstimate()" class="bg-blue-600 text-white px-4 py-2 rounded font-semibold hover:bg-blue-700">+ ${t('createEstimate')}</button>
            </div>
            
            ${currentEstimate ? `
              <div class="bg-gray-800 p-3 rounded mb-3">
                <h3 class="font-bold text-white mb-2">${t('estimateNumber')}: ${currentEstimate.number}</h3>
                <div class="grid grid-cols-3 gap-2 mb-2">
                  <input type="text" id="estimateItemDesc" placeholder="Descrizione" class="px-2 py-1 border rounded text-sm">
                  <input type="number" id="estimateItemQty" placeholder="Q.t√†" value="1" class="px-2 py-1 border rounded text-sm">
                  <input type="number" id="estimateItemPrice" placeholder="Prezzo" step="0.01" class="px-2 py-1 border rounded text-sm">
                </div>
                <button onclick="addEstimateItem()" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-green-700">+ ${t('add')}</button>
                
                <div class="mt-3 space-y-1">
                  ${currentEstimate.items.map((item, i) => `
                    <div class="flex justify-between text-sm text-gray-300">
                      <span>${item.description} x${item.quantity}</span>
                      <span>‚Ç¨${item.total.toFixed(2)}</span>
                    </div>
                  `).join('')}
                </div>
                <p class="text-right font-bold text-white mt-2">${t('total')}: ‚Ç¨${currentEstimate.total.toFixed(2)}</p>
              </div>
            ` : ''}

            <div class="space-y-2">
              ${vehicle.estimates?.map(est => `
                <div class="bg-gray-800 p-3 rounded flex justify-between items-center">
                  <div>
                    <p class="font-bold text-white">${est.number}</p>
                    <p class="text-sm text-gray-400">${est.date} | ${est.items.length} voci | ‚Ç¨${est.total.toFixed(2)}</p>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="convertEstimateToInvoice(${est.id})" class="bg-green-600 text-white px-2 py-1 rounded text-sm" ${est.status === 'converted' ? 'disabled' : ''}>${t('convertToInvoice')}</button>
                  </div>
                </div>
              `).join('') || `<p class="text-gray-400">${t('noResults')}</p>`}
            </div>
          </div>
        `;
        
        // Insert estimates section
        const historyIndex = app.innerHTML.indexOf('<h2 class="text-xl font-bold mb-3 text-white">üìã');
        if (historyIndex > -1) {
          app.innerHTML = app.innerHTML.substring(0, historyIndex) + estimatesHtml + app.innerHTML.substring(historyIndex);
        }
      }
    }

    async function init() {
      loadDataLocal();
      loadStock();
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        const targa = verifyClientCode(code);
        if (targa) {
          isClientMode = true; isMechanicMode = false; showLoginScreen = false; currentVehicle = targa;
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
      render();
      
      window.addEventListener('online', () => { isOffline = false; showOfflineIndicator(); });
      window.addEventListener('offline', () => { isOffline = true; showOfflineIndicator(); });
      
      if (USE_FIREBASE) {
        if (!window.firebaseReady) await new Promise(resolve => { window.addEventListener('firebaseReady', resolve, { once: true }); });
        if (code && !verifyClientCode(code)) {
          const parts = code.toUpperCase().split('-');
          if (parts.length >= 2) {
            const year = parts[parts.length - 1], targa = parts.slice(0, -1).join('-');
            const vehicleData = await loadFromFirestore(targa);
            if (vehicleData) {
              vehicles[targa] = vehicleData; saveDataLocal();
              const currentYear = new Date().getFullYear().toString(), lastYear = (currentYear - 1).toString();
              if (year === currentYear || year === lastYear) {
                isClientMode = true; isMechanicMode = false; showLoginScreen = false; currentVehicle = targa;
                showNotification(`‚úÖ ${t('autoAccess')}`); render();
              }
            } else { showNotification(`‚ùå ${t('linkInvalid')}`, 'error'); }
          }
        }
      }
    }

    init();
  </script>
</body>
</html>
